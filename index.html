<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Timer // Split</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500;800&display=swap" rel="stylesheet">
    <style>
        /* ===== THEME: MONOLITH ===== */
        :root {
            --bg-root: #000000;
            --bg-rail: #0a0a0a;
            --bg-active: #121212;
            
            --text-main: #ffffff;
            --text-dim: #999999;
            --text-accent: #ffffff;
            
            --accent-color: #3b82f6;
            --danger-color: #ef4444;
            --success-color: #10b981;
            
            --border: 1px solid #1a1a1a;
            
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: var(--bg-root);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            overflow: hidden;
        }

        /* ===== UTILITIES ===== */
        .mono { font-family: var(--font-mono); letter-spacing: -0.02em; font-variant-numeric: tabular-nums; }
        .dim { color: var(--text-dim); }
        .hidden { display: none !important; }

        /* ===== LAYOUT: SPLIT SCREEN ===== */
        .split-layout {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- LEFT RAIL (DATA) --- */
        .rail {
            width: 350px;
            background: var(--bg-rail);
            border-right: var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .rail-header {
            padding: 2rem;
            border-bottom: var(--border);
        }

        .rail-stats {
            padding: 2rem;
            border-bottom: var(--border);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .stat-block label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            margin-bottom: 0.25rem;
        }
        .stat-block .value {
            font-size: 1.25rem;
            font-weight: 500;
        }

        .rail-timeline {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .rail-timeline::-webkit-scrollbar { width: 0px; }

        .timeline-item {
            display: flex;
            padding: 1rem 2rem;
            border-bottom: 1px solid #111;
            color: var(--text-dim);
            transition: all 0.3s ease;
        }

        .timeline-item.active {
            background: var(--bg-active);
            color: var(--text-main);
            border-left: 3px solid var(--text-main);
            padding-left: calc(2rem - 3px);
        }

        .timeline-item.past {
            opacity: 0.3;
        }

        .timeline-level { width: 40px; font-size: 0.8rem; opacity: 0.5; }
        .timeline-blinds { flex: 1; font-weight: 500; text-align: right; }

        /* --- RIGHT ZONE (ACTION) --- */
        .action-zone {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 4rem;
        }

        .ticker-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 1rem 2rem;
            font-size: 1rem;
            color: #bbbbbb;
            border-bottom: var(--border);
            text-align: right;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .main-timer {
            font-size: 20vw;
            line-height: 0.9;
            font-weight: 800;
            letter-spacing: -0.05em;
            margin-bottom: 2rem;
            font-variant-numeric: tabular-nums;
        }

        .main-timer.critical { color: var(--danger-color); }

        .main-blinds {
            display: flex;
            align-items: baseline;
            gap: 2rem;
        }

        .blind-unit {
            text-align: center;
        }
        
        .blind-unit .val {
            font-size: 4rem;
            font-weight: 300;
            line-height: 1;
        }
        
        .blind-unit .lbl {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-top: 0.5rem;
            letter-spacing: 0.2em;
        }

        .blind-sep {
            font-size: 4rem;
            color: #222;
            font-weight: 100;
        }

        .progress-line {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: var(--text-main);
            transition: width 1s linear;
        }
        
        .progress-line.critical {
            background: var(--danger-color);
        }
        
        /* ===== STATUS BADGE ===== */
        .status-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 1px solid;
        }
        
        .status-badge.running {
            background: rgba(16, 185, 129, 0.15);
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .status-badge.paused {
            background: rgba(255, 255, 255, 0.1);
            border-color: #666;
            color: #999;
        }
        
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ===== CONTROL PANEL (FLOATING) ===== */
        .control-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 98;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .control-panel-overlay.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .control-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-rail);
            border: 1px solid #ffffff; /* UPDATED: Changed to white outline */
            border-radius: 0.5rem;
            padding: 2rem;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
            z-index: 99;
            max-height: 80vh;
            max-width: 90vw;
            min-width: 400px;
            overflow-y: auto;
        }
        
        .control-panel.open {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        .control-panel-section {
            margin-bottom: 2rem;
        }
        
        .control-panel-section:last-child {
            margin-bottom: 0;
        }
        
        .control-panel-title {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .control-panel-buttons {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .control-panel-divider {
            width: 2px;
            height: 36px;
            background: linear-gradient(180deg, transparent, #333, transparent);
            align-self: center;
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: 1px solid #333;
            border-radius: 0.375rem;
            font-family: var(--font-ui);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: var(--text-main);
        }
        
        .btn svg {
            flex-shrink: 0;
        }
        
        .btn-primary svg {
            color: #000;
            stroke: #000;
        }
        
        .btn:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }
        
        .btn:not(:disabled):hover {
            border-color: #fff;
            background: #111;
        }
        
        .btn:not(:disabled):active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: #fff;
            color: #000;
            border-color: #fff;
        }
        
        .btn-primary:not(:disabled):hover {
            background: #ddd;
            border-color: #ddd;
        }
        
        .btn-secondary {
            background: transparent;
            border: 1px solid #333;
            color: #fff;
        }
        
        .btn-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0;
            border-radius: 50%;
        }
        
        .btn-large {
            width: 3rem;
            height: 3rem;
        }

        /* ===== SETUP SCREENS / MODALS ===== */
        .modal-wrapper {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-root);
            z-index: 100;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .setup-content {
            width: 100%;
            max-width: 600px;
            margin-top: 5vh;
        }

        .setup-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .setup-title {
            font-weight: 300;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .setup-subtitle {
            font-size: 0.9rem;
            color: var(--text-dim);
        }
        
        .setup-card {
            background: rgba(255, 255, 255, 0.02);
            border: var(--border);
            border-radius: 0.5rem;
            padding: 2rem;
        }
        
        .setup-group {
            margin-bottom: 2rem;
        }
        
        .setup-group:last-child {
            margin-bottom: 0;
        }
        
        .setup-label {
            display: block;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-dim);
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .setup-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
        }
        
        .setup-value {
            font-size: 2rem;
            font-family: var(--font-mono);
            min-width: 120px;
            text-align: center;
        }
        
        .setup-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            color: var(--text-main);
            font-size: 0.9rem;
            font-family: var(--font-mono);
            text-align: center;
            width: 100%;
        }
        
        .setup-input:focus {
            outline: none;
            border-color: #666;
        }
        
        .setup-select {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 0.375rem;
            padding: 0.75rem 1rem;
            color: var(--text-main);
            font-size: 0.9rem;
            font-family: var(--font-mono);
            min-width: 150px;
        }
        
        .setup-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .setup-info {
            background: rgba(255, 255, 255, 0.03);
            border: var(--border);
            border-radius: 0.375rem;
            padding: 1rem;
            text-align: center;
            margin-top: 1.5rem;
            font-size: 0.85rem;
            color: var(--text-dim);
        }
        
        .flex-1 { flex: 1; }

        /* ===== SHUFFLE ANIMATION ===== */
        .shuffle-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .shuffle-slots {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 2rem;
            border-radius: 0.5rem;
            border: 2px solid #fff;
            min-width: 300px;
        }
        
        .shuffle-slot {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #333;
        }
        
        .shuffle-slot-number {
            color: var(--text-dim);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            width: 32px;
        }
        
        .shuffle-slot-name {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-main);
        }
        
        @keyframes slot-spin {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-10px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .shuffle-slot-name.spinning {
            animation: slot-spin 0.1s ease-in-out;
        }

        /* ===== CONFETTI ===== */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 9999;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* ===== MODAL/WARNING ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--bg-rail);
            border: var(--border);
            border-radius: 0.5rem;
            padding: 2rem;
            max-width: 400px;
            margin: 1rem;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-main);
        }
        
        .modal-text {
            color: var(--text-dim);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        /* ===== ANIMATIONS ===== */
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes slot-spin {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-10px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .split-layout { flex-direction: column-reverse; }
            .rail { width: 100%; height: 30%; border-right: none; border-top: var(--border); }
            .action-zone { height: 70%; padding: 2rem; }
            .main-timer { font-size: 25vw; }
            .rail-stats { display: none; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // SVG Icons
        const icons = {
            Play: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5,3 19,12 5,21"></polygon></svg>`,
            Pause: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>`,
            RotateCcw: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>`,
            SkipForward: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5,4 15,12 5,20"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>`,
            SkipBack: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="19,20 9,12 19,4"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>`,
            Settings: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`,
            Minus: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            Plus: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
            Users: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`,
            Volume2: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`,
            VolumeX: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>`,
            Maximize: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>`,
            Minimize: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></svg>`,
            Shuffle: `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 3 21 3 21 8"></polyline><line x1="4" y1="20" x2="21" y2="3"></line><polyline points="21 16 21 21 16 21"></polyline><line x1="15" y1="15" x2="21" y2="21"></line><line x1="4" y1="4" x2="9" y2="9"></line></svg>`
        };

        class PokerTimer {
            constructor() {
                this.blindLevels = [
                    { level: 1, small: 500, big: 1000 },
                    { level: 2, small: 800, big: 1600 },
                    { level: 3, small: 1200, big: 2400 },
                    { level: 4, small: 1800, big: 3600 },
                    { level: 5, small: 2500, big: 5000 },
                    { level: 6, small: 3500, big: 7000 },
                    { level: 7, small: 5000, big: 10000 },
                    { level: 8, small: 7000, big: 14000 },
                    { level: 9, small: 10000, big: 20000 },
                    { level: 10, small: 15000, big: 30000 },
                    { level: 11, small: 20000, big: 40000 },
                    { level: 12, small: 30000, big: 60000 },
                    { level: 13, small: 40000, big: 80000 },
                    { level: 14, small: 50000, big: 100000 },
                    { level: 15, small: 65000, big: 130000 },
                    { level: 16, small: 80000, big: 160000 },
                    { level: 17, small: 100000, big: 200000 },
                    { level: 18, small: 150000, big: 300000 },
                ];

                this.showSetup = true;
                this.showPayouts = false;
                this.showSeating = false;
                this.showRedraw = false;
                this.showWarning = false;
                this.setupData = {
                    totalPlayers: 7,
                    levelDuration: 25,
                    startingStack: 100000,
                    buyIn: 2000,
                    rebuyCloseLevel: 0
                };
                this.playerNames = [];
                this.originalPlayerNames = [];
                this.tableCount = 1;
                this.tableAssignments = null;
                this.redrawSelections = [];
                this.redrawResult = null;
                this.isShuffling = false;
                this.shuffleNames = [];
                this.shuffleInterval = null;
                this.payouts = [];
                this.placesPaid = 3;
                this.currentLevel = 0;
                this.playersRemaining = 7;
                this.rebuys = 0;
                this.timeLeft = 25 * 60;
                this.isRunning = false;
                this.isExtended = false;
                this.totalTime = 25 * 60;
                this.timerInterval = null;
                this.soundEnabled = true;
                this.isFullscreen = false;
                this.audioContextInitialized = false;
                this.controlPanelOpen = false;
                
                // Scroll tracking
                this.userIsScrolling = false;
                this.userScrollTimeout = null;

                this.setupKeyboardShortcuts();
                this.setupTimelineScrollListener();
                this.setupFullscreenListener();
                this.render();
                this.startTimer();
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                    
                    if (e.code === 'Space') {
                        e.preventDefault();
                        if (!this.showSetup && !this.showPayouts && !this.showSeating && !this.showRedraw && this.currentLevel < this.blindLevels.length - 1) {
                            this.toggleTimer();
                        }
                    }
                    
                    if (e.code === 'Backspace') {
                        e.preventDefault();
                        if (!this.showSetup && !this.showPayouts && !this.showSeating && !this.showRedraw) {
                            this.eliminatePlayer();
                        }
                    }
                    
                    if (e.code === 'ArrowLeft') {
                        e.preventDefault();
                        if (!this.showSetup && !this.showPayouts && !this.showSeating && !this.showRedraw) {
                            this.prevLevel();
                        }
                    }
                    
                    if (e.code === 'ArrowRight') {
                        e.preventDefault();
                        if (!this.showSetup && !this.showPayouts && !this.showSeating && !this.showRedraw) {
                            this.nextLevel();
                        }
                    }
                    
                    if (e.code === 'KeyF') {
                        e.preventDefault();
                        this.toggleFullscreen();
                    }
                    
                    if (e.code === 'KeyT') {
                        e.preventDefault();
                        if (!this.showSetup && !this.showPayouts && !this.showSeating && !this.showRedraw && this.currentLevel < this.blindLevels.length - 1) {
                            this.addTwoMinutes();
                        }
                    }
                    
                    if (e.code === 'Enter') {
                        e.preventDefault();
                        if (!this.showSetup && !this.showPayouts && !this.showSeating && !this.showRedraw) {
                            this.toggleControlPanel();
                        }
                    }
                    
                    if (e.code === 'KeyR') {
                        e.preventDefault();
                        if (!this.showSetup && !this.showPayouts && !this.showSeating && !this.showRedraw) {
                            this.addRebuy();
                        }
                    }
                });
            }

            setupFullscreenListener() {
                document.addEventListener('fullscreenchange', () => {
                    this.isFullscreen = !!document.fullscreenElement;
                    this.render();
                });
            }
            
            setupTimelineScrollListener() {
                // Use event delegation since timeline is re-rendered
                document.addEventListener('scroll', (e) => {
                    const timeline = e.target.closest('.rail-timeline');
                    if (timeline) {
                        // User is manually scrolling
                        this.userIsScrolling = true;
                        
                        // Clear existing timeout
                        if (this.userScrollTimeout) {
                            clearTimeout(this.userScrollTimeout);
                        }
                        
                        // Reset flag after 2 seconds of no scrolling
                        this.userScrollTimeout = setTimeout(() => {
                            this.userIsScrolling = false;
                        }, 2000);
                    }
                }, true); // Use capture phase to catch scroll events
            }

            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.log('Fullscreen error:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            }

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                
                this.timerInterval = setInterval(() => {
                    const isLastLevel = this.currentLevel === this.blindLevels.length - 1;
                    
                    if (this.isRunning && this.timeLeft > 0 && !isLastLevel) {
                        this.timeLeft--;
                        
                        if (this.timeLeft === 60 && !this.isExtended) {
                            this.playWarningSound();
                        }
                        
                        if (this.timeLeft === 2 && !this.isExtended) {
                            this.playLevelEndSound();
                        }
                        
                        this.render();
                    } else if (this.timeLeft === 0 && this.isRunning && !this.isExtended && !isLastLevel) {
                        if (this.currentLevel < this.blindLevels.length - 1) {
                            this.currentLevel++;
                            this.timeLeft = this.totalTime;
                            this.isExtended = false;
                            this.userIsScrolling = false; // Allow auto-scroll on level change
                            this.render();
                            // Scroll when level changes
                            this.scrollToCurrentLevel();
                        } else {
                            this.isRunning = false;
                            this.render();
                        }
                    }
                }, 1000);
            }

            initAudioContext() {
                if (!this.audioContextInitialized) {
                    try {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        ctx.resume();
                        ctx.close();
                        this.audioContextInitialized = true;
                    } catch (e) {
                        console.log('Audio context initialization:', e);
                    }
                }
            }

            playWarningSound() {
                if (!this.soundEnabled) return;
                try {
                    const audio = new Audio('sounds/mixkit-repeating-arcade-beep-1084.mp3');
                    audio.volume = 0.8;
                    audio.play().catch(e => console.log('Could not play warning sound:', e));
                } catch (e) {
                    console.log('Could not play warning sound:', e);
                }
            }

            playLevelEndSound() {
                if (!this.soundEnabled) return;
                try {
                    const audio = new Audio('sounds/mixkit-arcade-race-game-countdown-1952.mp3');
                    audio.volume = 0.8;
                    audio.play().catch(e => console.log('Could not play level end sound:', e));
                } catch (e) {
                    console.log('Could not play level end sound:', e);
                }
            }

            createConfetti() {
                const colors = ['#ffffff', '#10b981', '#ef4444', '#3b82f6', '#ec4899'];
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-10px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animation = `confetti-fall ${2 + Math.random() * 2}s linear forwards`;
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 4500);
                }
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }

            formatNumber(num) {
                return num.toLocaleString();
            }

            formatNumberCompact(num) {
                if (num >= 1000000) {
                    return (num / 1000000).toFixed(num % 1000000 === 0 ? 0 : 1) + 'M';
                } else if (num >= 1000) {
                    return (num / 1000).toFixed(num % 1000 === 0 ? 0 : 1) + 'k';
                }
                return num.toString();
            }

            getOrdinal(num) {
                const suffixes = ['th', 'st', 'nd', 'rd'];
                const v = num % 100;
                return num + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
            }

            getCurrentPayouts() {
                const currentPayouts = [...this.payouts];
                
                for (let i = 0; i < this.rebuys; i++) {
                    const positionIndex = i % this.placesPaid;
                    currentPayouts[positionIndex] += this.setupData.buyIn;
                }
                
                return currentPayouts;
            }

            getPayoutTickerContent() {
                const medals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
                const currentPayouts = this.getCurrentPayouts();
                return currentPayouts.slice(0, this.placesPaid).map((amount, index) => {
                    const medal = index < 3 ? medals[index] + ' ' : '';
                    return `${medal}${this.getOrdinal(index + 1)}: ${this.formatNumber(amount)} THB`;
                }).join(' â€¢ ');
            }

            areRebuysOpen() {
                if (this.setupData.rebuyCloseLevel === 0) return false;
                return this.currentLevel < this.setupData.rebuyCloseLevel;
            }

            isGameInProgress() {
                return this.currentLevel > 0 || 
                       this.playersRemaining < this.setupData.totalPlayers || 
                       this.timeLeft < this.totalTime || 
                       this.isRunning;
            }

            scrollToCurrentLevel() {
                // Don't auto-scroll if user is actively scrolling
                if (this.userIsScrolling) {
                    return;
                }
                
                // Scroll so the active level appears at a fixed position at the top
                setTimeout(() => {
                    const timeline = document.querySelector('.rail-timeline');
                    const active = document.querySelector('.timeline-item.active');
                    
                    if (timeline && active) {
                        // Fixed position: keep active item at the very top of the timeline
                        const fixedOffset = 0; // At the very top (1st slot)
                        
                        // Calculate how much to scroll to put active item at the fixed position
                        const scrollTop = active.offsetTop - timeline.offsetTop - fixedOffset;
                        
                        // Scroll the list (will naturally stop at max scroll)
                        timeline.scrollTop = Math.max(0, scrollTop);
                    }
                }, 0);
            }

            render() {
                const app = document.getElementById('app');
                
                // Always save scroll position before render (DOM will be destroyed)
                const timeline = document.querySelector('.rail-timeline');
                let scrollPosition = 0;
                if (timeline) {
                    scrollPosition = timeline.scrollTop;
                }
                
                let content = '';
                
                if (this.showSetup) {
                    content = this.renderSetup();
                } else if (this.showPayouts) {
                    content = this.renderPayouts();
                } else if (this.showSeating) {
                    content = this.renderSeating();
                } else if (this.showRedraw) {
                    content = this.renderRedrawSeating();
                } else if (this.showWarning) {
                    content = this.renderGame() + this.renderWarning();
                } else {
                    content = this.renderGame();
                }
                
                if (this.isShuffling) {
                    content += this.renderShuffleAnimation();
                }
                
                app.innerHTML = content;
                
                // Always restore scroll position to prevent jumping
                if (timeline && scrollPosition > 0) {
                    const newTimeline = document.querySelector('.rail-timeline');
                    if (newTimeline) {
                        newTimeline.scrollTop = scrollPosition;
                    }
                }
            }

            // Render Methods
            renderSetup() {
                const firstBigBlind = this.blindLevels[0].big;
                const startingBB = Math.round(this.setupData.startingStack / firstBigBlind);
                const totalPrizePool = this.setupData.totalPlayers * this.setupData.buyIn;
                
                return `
                    <div class="modal-wrapper">
                        <div class="setup-content">
                            <div class="setup-header">
                                <h1 class="setup-title">TOURNAMENT SETUP</h1>
                                <p class="setup-subtitle">Configure your poker game settings</p>
                            </div>

                            <div class="setup-card">
                                <div class="setup-group">
                                    <label class="setup-label">Number of Players</label>
                                    <div class="setup-control">
                                        <button class="btn btn-icon" onclick="app.adjustPlayers(-1)">
                                            ${icons.Minus}
                                        </button>
                                        <div class="setup-value mono">${this.setupData.totalPlayers}</div>
                                        <button class="btn btn-icon" onclick="app.adjustPlayers(1)">
                                            ${icons.Plus}
                                        </button>
                                    </div>
                                </div>

                                <div class="setup-group">
                                    <label class="setup-label">Buy-in Amount (THB)</label>
                                    <div class="setup-control">
                                        <button class="btn btn-icon" onclick="app.adjustBuyIn(-1000)">
                                            ${icons.Minus}
                                        </button>
                                        <div class="setup-value mono">${this.formatNumber(this.setupData.buyIn)}</div>
                                        <button class="btn btn-icon" onclick="app.adjustBuyIn(1000)">
                                            ${icons.Plus}
                                        </button>
                                    </div>
                                </div>

                                <div class="setup-group">
                                    <label class="setup-label">Level Duration (minutes)</label>
                                    <div class="setup-control">
                                        <button class="btn btn-icon" onclick="app.adjustDuration(-1)">
                                            ${icons.Minus}
                                        </button>
                                        <div class="setup-value mono">${this.setupData.levelDuration}</div>
                                        <button class="btn btn-icon" onclick="app.adjustDuration(1)">
                                            ${icons.Plus}
                                        </button>
                                    </div>
                                </div>

                                <div class="setup-group">
                                    <label class="setup-label">Starting Stack</label>
                                    <div class="setup-control">
                                        <button class="btn btn-icon" onclick="app.adjustStack(-5000)">
                                            ${icons.Minus}
                                        </button>
                                        <div class="setup-value mono">${this.formatNumber(this.setupData.startingStack)}</div>
                                        <button class="btn btn-icon" onclick="app.adjustStack(5000)">
                                            ${icons.Plus}
                                        </button>
                                    </div>
                                </div>

                                <div class="setup-group">
                                    <label class="setup-label">Rebuys Close at Level</label>
                                    <div style="display: flex; justify-content: center;">
                                        <select onchange="app.adjustRebuyCloseLevel(this.value)" class="setup-select">
                                            <option value="0" ${this.setupData.rebuyCloseLevel === 0 ? 'selected' : ''}>Off</option>
                                            ${this.blindLevels.map(level => 
                                                `<option value="${level.level}" ${this.setupData.rebuyCloseLevel === level.level ? 'selected' : ''}>Level ${level.level}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>

                                <div class="setup-info">
                                    <div style="margin-bottom: 0.5rem;">
                                        Starting: ${startingBB} BB â€¢ Prize Pool: ${this.formatNumber(totalPrizePool)} THB
                                    </div>
                                </div>
                            </div>

                            <button onclick="app.goToPayouts()" class="btn btn-primary" style="width: 100%; padding: 1rem; margin-top: 2rem;">
                                Next: Payouts
                            </button>
                        </div>
                    </div>
                `;
            }

            renderPayouts() {
                const totalPool = this.setupData.totalPlayers * this.setupData.buyIn;
                const allocated = this.payouts.reduce((a, b) => a + b, 0);
                const remaining = totalPool - allocated;
                const isValid = remaining === 0;

                return `
                    <div class="modal-wrapper">
                        <div class="setup-content">
                            <div class="setup-header">
                                <h1 class="setup-title">PRIZE PAYOUTS</h1>
                                <p class="setup-subtitle">Distribute ${this.formatNumber(totalPool)} THB prize pool</p>
                            </div>

                            <div class="setup-card">
                                <div class="setup-info" style="margin-top: 0; margin-bottom: 2rem; color: ${isValid ? 'var(--success-color)' : 'var(--danger-color)'}; font-size: 1rem;">
                                    <div class="mono">REMAINING: ${this.formatNumber(remaining)} THB</div>
                                </div>

                                <div class="setup-group">
                                    <label class="setup-label">Places Paid</label>
                                    <div style="display: flex; justify-content: center;">
                                        <select onchange="app.updatePlacesPaid(this.value)" class="setup-select">
                                            ${Array.from({length: Math.floor(this.setupData.totalPlayers / 2)}, (_, i) => i + 1).map(n => 
                                                `<option value="${n}" ${this.placesPaid === n ? 'selected' : ''}>${n} ${n === 1 ? 'Place' : 'Places'}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>

                                ${this.payouts.map((amount, index) => `
                                    <div class="setup-group">
                                        <label class="setup-label">${this.getOrdinal(index + 1)} Place</label>
                                        <div class="setup-control">
                                            <button class="btn btn-icon" onclick="app.adjustPayout(${index}, -1000)">
                                                ${icons.Minus}
                                            </button>
                                            <input 
                                                type="number" 
                                                value="${amount}" 
                                                onchange="app.updatePayout(${index}, this.value)"
                                                class="setup-input"
                                                style="max-width: 150px;"
                                            >
                                            <button class="btn btn-icon" onclick="app.adjustPayout(${index}, 1000)">
                                                ${icons.Plus}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="setup-buttons">
                                <button onclick="app.backToSetup()" class="btn btn-secondary flex-1">
                                    Back to Setup
                                </button>
                                <button onclick="app.goToSeating()" class="btn btn-primary flex-1" ${!isValid ? 'disabled' : ''}>
                                    Next: Seating
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSeating() {
                if (this.tableAssignments) {
                    return this.renderSeatingResult();
                }
                return this.renderSeatingInput();
            }

            renderSeatingInput() {
                return `
                    <div class="modal-wrapper">
                        <div class="setup-content">
                            <div class="setup-header">
                                <h1 class="setup-title">SEATING ASSIGNMENT</h1>
                                <p class="setup-subtitle">Enter player names for random seat assignment</p>
                            </div>

                            <div class="setup-card">
                                <div class="setup-group">
                                    <label class="setup-label">Number of Tables</label>
                                    <div style="display: flex; justify-content: center;">
                                        <select onchange="app.updateTableCount(this.value)" class="setup-select">
                                            <option value="1" ${this.tableCount === 1 ? 'selected' : ''}>1 Table</option>
                                            <option value="2" ${this.tableCount === 2 ? 'selected' : ''}>2 Tables</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="setup-group">
                                    <label class="setup-label">Player Names (${this.setupData.totalPlayers} players)</label>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                        ${this.playerNames.map((name, index) => `
                                            <input 
                                                type="text" 
                                                value="${name}" 
                                                onchange="app.updatePlayerName(${index}, this.value)"
                                                oninput="app.updatePlayerName(${index}, this.value)"
                                                class="setup-input"
                                                placeholder="Player ${index + 1}"
                                            >
                                        `).join('')}
                                    </div>
                                </div>

                                <button onclick="app.assignSeats()" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                                    ${icons.Shuffle} Randomly Assign Seats
                                </button>
                            </div>

                            <button onclick="app.backToPayouts()" class="btn btn-secondary" style="width: 100%; padding: 0.75rem; margin-top: 1rem;">
                                Back to Payouts
                            </button>
                        </div>
                    </div>
                `;
            }

            renderSeatingResult() {
                const tables = this.tableCount === 1 
                    ? [{ key: 'pokerTable', name: 'Poker Table' }]
                    : [{ key: 'pokerTable', name: 'Poker Table' }, { key: 'kitchenTable', name: 'Kitchen Table' }];

                return `
                    <div class="modal-wrapper">
                        <div class="setup-content" style="max-width: 900px;">
                            <div class="setup-header">
                                <h1 class="setup-title">TABLE ASSIGNMENTS</h1>
                                <p class="setup-subtitle">Players have been randomly assigned to seats</p>
                            </div>

                            <div style="display: grid; grid-template-columns: ${this.tableCount === 1 ? '1fr' : '1fr 1fr'}; gap: 2rem;">
                                ${tables.map(table => `
                                    <div class="setup-card">
                                        <h2 style="text-align: center; font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">
                                            ${table.name}
                                        </h2>
                                        <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                            ${this.tableAssignments[table.key].map((player, index) => {
                                                const position = this.getPositionLabel(index);
                                                return `
                                                    <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.03); border-radius: 0.375rem; padding: 0.75rem 1rem; border: 1px solid #333;">
                                                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                            <span class="mono dim" style="font-size: 0.75rem; width: 32px;">#${index + 1}</span>
                                                            <span style="font-size: 1rem; font-weight: 500;">${player}</span>
                                                        </div>
                                                        ${position ? `
                                                            <span style="background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; color: var(--text-dim);">
                                                                ${position}
                                                            </span>
                                                        ` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <button onclick="app.startTournament()" class="btn btn-primary" style="width: 100%; padding: 1rem; margin-top: 2rem;">
                                Start Tournament
                            </button>
                        </div>
                    </div>
                `;
            }

            renderGame() {
                const cur = this.blindLevels[this.currentLevel];
                const pool = (this.setupData.totalPlayers * this.setupData.buyIn) + (this.rebuys * this.setupData.buyIn);
                const avgChips = Math.round((this.setupData.totalPlayers * this.setupData.startingStack) / this.playersRemaining);
                
                // UPDATED: Logic to remove decimals if BB > 10
                const rawBB = avgChips / cur.big;
                const avgBB = rawBB.toFixed(rawBB >= 10 ? 0 : 1);
                
                const pct = ((this.totalTime - this.timeLeft) / this.totalTime) * 100;

                return `
                    <div class="split-layout">
                        <div class="rail">
                            <div class="rail-header">
                                <div style="font-weight:800; letter-spacing:-0.05em; font-size:1.5rem;">RISITHAI<br>POKER TOUR</div>
                            </div>
                            
                            <div class="rail-stats">
                                <div class="stat-block">
                                    <label>Players</label>
                                    <div class="value">${this.playersRemaining}/${this.setupData.totalPlayers}</div>
                                </div>
                                <div class="stat-block">
                                    <label>Prize Pool</label>
                                    <div class="value mono">${this.formatNumberCompact(pool)}</div>
                                </div>
                                <div class="stat-block">
                                    <label>Avg Chips</label>
                                    <div class="value mono">${this.formatNumberCompact(avgChips)}</div>
                                </div>
                                <div class="stat-block">
                                    <label>Avg BB</label>
                                    <div class="value mono">${avgBB}</div>
                                </div>
                            </div>

                            <div class="rail-timeline">
                                ${this.blindLevels.map((l, i) => `
                                    <div class="timeline-item ${i === this.currentLevel ? 'active' : ''} ${i < this.currentLevel ? 'past' : ''}">
                                        <div class="timeline-level mono">L${l.level}</div>
                                        <div class="timeline-blinds mono">${this.formatNumber(l.small)} / ${this.formatNumber(l.big)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="action-zone">
                            <div class="status-badge ${this.isRunning ? 'running' : 'paused'}">
                                <div class="status-indicator"></div>
                                ${this.isRunning ? 'Running' : 'Paused'}
                            </div>
                            
                            <div class="ticker-bar">
                                ${this.getPayoutTickerContent()}
                            </div>

                            <div class="main-timer mono ${!this.isRunning ? 'dim' : (this.timeLeft < 60 && !this.isExtended ? 'critical' : '')}">
                                ${this.currentLevel === this.blindLevels.length - 1 ? 'âˆž' : 
                                  this.isExtended ? 'EXT' : this.formatTime(this.timeLeft)}
                            </div>

                            <div class="main-blinds">
                                <div class="blind-unit">
                                    <div class="val mono">${this.formatNumber(cur.small)}</div>
                                    <div class="lbl">Small Blind</div>
                                </div>
                                <div class="blind-sep">/</div>
                                <div class="blind-unit">
                                    <div class="val mono">${this.formatNumber(cur.big)}</div>
                                    <div class="lbl">Big Blind</div>
                                </div>
                            </div>

                            <div class="progress-line ${this.timeLeft < 60 && !this.isExtended ? 'critical' : ''}" style="width:${this.currentLevel === this.blindLevels.length - 1 ? '100' : pct}%"></div>
                        </div>
                    </div>
                    
                    <div class="control-panel-overlay ${this.controlPanelOpen ? 'open' : ''}" onclick="app.toggleControlPanel()"></div>
                    <div class="control-panel ${this.controlPanelOpen ? 'open' : ''}">
                        <div class="control-panel-section">
                            <div class="control-panel-title">Timer Controls</div>
                            <div class="control-panel-buttons">
                                <button onclick="app.prevLevel()" ${this.currentLevel === 0 ? 'disabled' : ''} 
                                    class="btn btn-icon" title="Previous Level (â†)">
                                    ${icons.SkipBack}
                                </button>
                                
                                <button onclick="app.toggleTimer()" ${this.currentLevel === this.blindLevels.length - 1 ? 'disabled' : ''} 
                                    class="btn btn-primary btn-large" title="Play/Pause (SPACE)">
                                    ${this.isRunning ? icons.Pause : icons.Play}
                                </button>
                                
                                <button onclick="app.nextLevel()" ${this.currentLevel === this.blindLevels.length - 1 ? 'disabled' : ''} 
                                    class="btn btn-icon" title="Next Level (â†’)">
                                    ${icons.SkipForward}
                                </button>
                                
                                <button onclick="app.addTwoMinutes()" ${this.currentLevel === this.blindLevels.length - 1 ? 'disabled' : ''} 
                                    class="btn btn-secondary" title="Add 2 minutes (T)">
                                    +2 min
                                </button>
                                
                                <button onclick="app.toggleExtend()" ${this.currentLevel === this.blindLevels.length - 1 ? 'disabled' : ''} 
                                    class="btn ${this.isExtended ? 'btn-primary' : 'btn-secondary'}" title="Extend Level">
                                    ${this.isExtended ? 'Extended' : 'Extend'}
                                </button>
                            </div>
                        </div>
                        
                        <div class="control-panel-section">
                            <div class="control-panel-title">Player Controls</div>
                            <div class="control-panel-buttons">
                                <button onclick="app.eliminatePlayer()" ${this.playersRemaining <= 1 ? 'disabled' : ''} 
                                    class="btn btn-secondary" title="Eliminate Player (BACKSPACE)">
                                    ${icons.Minus} OUT
                                </button>
                                <button onclick="app.addPlayer()" ${this.playersRemaining >= this.setupData.totalPlayers ? 'disabled' : ''} 
                                    class="btn btn-icon" title="Undo elimination">
                                    ${icons.RotateCcw}
                                </button>
                                
                                ${this.setupData.rebuyCloseLevel > 0 ? `
                                    <div class="control-panel-divider"></div>
                                    
                                    <button onclick="app.addRebuy()" ${!this.areRebuysOpen() ? 'disabled' : ''} 
                                        class="btn btn-primary" title="Add Rebuy (R)">
                                        ${icons.Plus} Rebuy
                                    </button>
                                    <button onclick="app.undoRebuy()" ${!this.areRebuysOpen() || this.rebuys === 0 ? 'disabled' : ''} 
                                        class="btn btn-icon" title="Cancel last rebuy">
                                        ${icons.RotateCcw}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="control-panel-section">
                            <div class="control-panel-title">Settings</div>
                            <div class="control-panel-buttons">
                                <button onclick="app.toggleSound()" class="btn btn-secondary" title="Toggle Sound">
                                    ${this.soundEnabled ? icons.Volume2 : icons.VolumeX}
                                </button>
                                
                                <button onclick="app.testSound()" class="btn btn-secondary" title="Test Sound Alert">
                                    ${icons.Volume2} Test
                                </button>
                                
                                <button onclick="app.toggleFullscreen()" class="btn btn-secondary" title="Fullscreen (F)">
                                    ${this.isFullscreen ? icons.Minimize : icons.Maximize}
                                </button>
                                
                                <button onclick="app.showRedrawSeating()" class="btn btn-secondary" title="Redraw Table Seating" ${this.originalPlayerNames.length === 0 ? 'disabled' : ''}>
                                    ${icons.Shuffle} Redraw
                                </button>
                                
                                <button onclick="app.showSettingsMenu()" class="btn btn-secondary">
                                    ${icons.Settings} Setup
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderRedrawSeating() {
                if (this.redrawResult) {
                    return this.renderRedrawResult();
                }

                const selectedCount = this.redrawSelections.filter(s => s).length;
                const canRedraw = selectedCount === this.playersRemaining;

                return `
                    <div class="modal-wrapper">
                        <div class="setup-content">
                            <div class="setup-header">
                                <h1 class="setup-title">FINAL TABLE DRAW</h1>
                                <p class="setup-subtitle">Select players still in the tournament</p>
                            </div>

                            <div class="setup-card">
                                <div class="setup-group">
                                    <label class="setup-label">
                                        Players (${selectedCount} selected, ${this.playersRemaining} remaining)
                                    </label>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                        ${this.originalPlayerNames.map((name, index) => `
                                            <div style="display: flex; align-items: center; gap: 0.75rem; background: ${this.redrawSelections[index] ? 'rgba(16, 185, 129, 0.1)' : 'rgba(0, 0, 0, 0.3)'}; border-radius: 0.375rem; padding: 0.75rem; border: 1px solid ${this.redrawSelections[index] ? 'rgba(16, 185, 129, 0.3)' : '#333'}; cursor: pointer; transition: all 0.2s;" onclick="app.togglePlayerForRedraw(${index})">
                                                <input 
                                                    type="checkbox" 
                                                    ${this.redrawSelections[index] ? 'checked' : ''}
                                                    style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--success-color);"
                                                    onclick="event.stopPropagation(); app.togglePlayerForRedraw(${index})"
                                                >
                                                <span style="font-size: 0.9rem; font-weight: 500; color: ${this.redrawSelections[index] ? 'var(--text-main)' : 'var(--text-dim)'};">
                                                    ${name}
                                                </span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>

                                <button onclick="app.performRedraw()" class="btn btn-primary" style="width: 100%; padding: 1rem;" ${!canRedraw ? 'disabled' : ''}>
                                    ${icons.Shuffle} Draw Final Table
                                </button>
                                ${!canRedraw && selectedCount > 0 ? `
                                    <div style="text-align: center; color: var(--danger-color); font-size: 0.75rem; margin-top: 0.75rem;">
                                        Select exactly ${this.playersRemaining} players to match current player count
                                    </div>
                                ` : ''}
                            </div>

                            <button onclick="app.cancelRedraw()" class="btn btn-secondary" style="width: 100%; padding: 0.75rem; margin-top: 1rem;">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }

            renderRedrawResult() {
                return `
                    <div class="modal-wrapper">
                        <div class="setup-content">
                            <div class="setup-header">
                                <h1 class="setup-title">FINAL TABLE ASSIGNMENT</h1>
                                <p class="setup-subtitle">Players have been randomly assigned to seats</p>
                            </div>

                            <div class="setup-card">
                                <h2 style="text-align: center; font-size: 1.5rem; font-weight: 600; margin-bottom: 1.5rem;">
                                    Poker Table
                                </h2>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${this.redrawResult.map((player, index) => {
                                        const position = this.getPositionLabel(index);
                                        return `
                                            <div style="display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.03); border-radius: 0.375rem; padding: 0.75rem 1rem; border: 1px solid #333;">
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <span class="mono dim" style="font-size: 0.75rem; width: 32px;">#${index + 1}</span>
                                                    <span style="font-size: 1rem; font-weight: 500;">${player}</span>
                                                </div>
                                                ${position ? `
                                                    <span style="background: rgba(255, 255, 255, 0.1); padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600; color: var(--text-dim);">
                                                        ${position}
                                                    </span>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>

                            <button onclick="app.closeRedrawResult()" class="btn btn-primary" style="width: 100%; padding: 1rem; margin-top: 2rem;">
                                Done
                            </button>
                        </div>
                    </div>
                `;
            }

            renderShuffleAnimation() {
                const slotsToShow = Math.min(this.shuffleNames.length, 10);
                const initialShuffle = this.shuffleArray([...this.shuffleNames]);
                
                return `
                    <div class="shuffle-overlay">
                        <div class="shuffle-slots">
                            ${initialShuffle.slice(0, slotsToShow).map((name, index) => `
                                <div class="shuffle-slot">
                                    <span class="shuffle-slot-number">#${index + 1}</span>
                                    <span class="shuffle-slot-name">${name}</span>
                                </div>
                            `).join('')}
                            ${this.shuffleNames.length > 10 ? `
                                <div style="text-align: center; color: var(--text-dim); font-size: 0.75rem; padding-top: 0.75rem;">
                                    ... and ${this.shuffleNames.length - 10} more
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            renderWarning() {
                return `
                    <div class="modal-overlay">
                        <div class="modal-content">
                            <h3 class="modal-title">âš ï¸ Warning</h3>
                            <p class="modal-text">
                                Going to settings will end the current tournament. All progress will be lost.
                            </p>
                            <div class="modal-buttons">
                                <button onclick="app.cancelShowSetup()" class="btn btn-secondary">
                                    Cancel
                                </button>
                                <button onclick="app.confirmShowSetup()" class="btn btn-primary">
                                    End Tournament
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Control Methods
            adjustPlayers(delta) {
                this.setupData.totalPlayers = Math.max(2, Math.min(20, this.setupData.totalPlayers + delta));
                
                // Ensure placesPaid doesn't exceed max (half of total players, rounded down)
                const maxPlacesPaid = Math.floor(this.setupData.totalPlayers / 2);
                if (this.placesPaid > maxPlacesPaid) {
                    this.placesPaid = maxPlacesPaid;
                    this.payouts = new Array(this.placesPaid).fill(0);
                }
                
                this.render();
            }

            adjustBuyIn(delta) {
                this.setupData.buyIn = Math.max(100, this.setupData.buyIn + delta);
                this.render();
            }

            adjustDuration(delta) {
                this.setupData.levelDuration = Math.max(1, Math.min(60, this.setupData.levelDuration + delta));
                this.render();
            }

            adjustStack(delta) {
                this.setupData.startingStack = Math.max(5000, Math.min(500000, this.setupData.startingStack + delta));
                this.render();
            }

            adjustRebuyCloseLevel(value) {
                this.setupData.rebuyCloseLevel = parseInt(value);
                this.render();
            }

            goToPayouts() {
                this.showSetup = false;
                this.showPayouts = true;
                
                // Ensure placesPaid is within valid range
                const maxPlacesPaid = Math.floor(this.setupData.totalPlayers / 2);
                if (this.placesPaid > maxPlacesPaid) {
                    this.placesPaid = maxPlacesPaid;
                }
                if (this.placesPaid < 1) {
                    this.placesPaid = 1;
                }
                
                if (this.payouts.length === 0) {
                    this.payouts = new Array(this.placesPaid).fill(0);
                }
                this.render();
            }

            backToSetup() {
                this.showSetup = true;
                this.showPayouts = false;
                this.render();
            }

            updatePlacesPaid(value) {
                this.placesPaid = parseInt(value);
                this.payouts = new Array(this.placesPaid).fill(0);
                this.render();
            }

            updatePayout(index, value) {
                this.payouts[index] = parseInt(value) || 0;
                this.render();
            }

            adjustPayout(index, delta) {
                const currentValue = this.payouts[index] || 0;
                this.payouts[index] = Math.max(0, currentValue + delta);
                this.render();
            }

            goToSeating() {
                this.showPayouts = false;
                this.showSeating = true;
                this.playerNames = new Array(this.setupData.totalPlayers).fill('');
                this.tableCount = this.setupData.totalPlayers > 10 ? 2 : 1;
                this.tableAssignments = null;
                this.render();
            }

            backToPayouts() {
                this.showSeating = false;
                this.showPayouts = true;
                this.render();
            }

            updatePlayerName(index, value) {
                this.playerNames[index] = value;
            }

            updateTableCount(value) {
                this.tableCount = parseInt(value);
                this.tableAssignments = null;
                this.render();
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }

            assignSeats() {
                const filledNames = this.playerNames.filter(n => n.trim() !== '');
                if (filledNames.length !== this.setupData.totalPlayers) {
                    alert(`Please enter all ${this.setupData.totalPlayers} player names`);
                    return;
                }

                this.shuffleNames = filledNames;
                this.startShuffleAnimation(() => {
                    const shuffled = this.shuffleArray(filledNames);
                    
                    if (this.tableCount === 1) {
                        this.tableAssignments = {
                            pokerTable: shuffled
                        };
                    } else {
                        const pokerTableCount = Math.ceil(this.setupData.totalPlayers / 2);
                        this.tableAssignments = {
                            pokerTable: shuffled.slice(0, pokerTableCount),
                            kitchenTable: shuffled.slice(pokerTableCount)
                        };
                    }
                    this.render();
                });
            }

            startShuffleAnimation(onComplete) {
                this.isShuffling = true;
                this.render();
                
                let iterations = 0;
                const maxIterations = 30;
                
                this.shuffleInterval = setInterval(() => {
                    iterations++;
                    
                    const slots = document.querySelectorAll('.shuffle-slot-name');
                    const shuffledDisplay = this.shuffleArray([...this.shuffleNames]);
                    
                    slots.forEach((slot, index) => {
                        if (index < shuffledDisplay.length) {
                            slot.textContent = shuffledDisplay[index];
                            slot.classList.add('spinning');
                            setTimeout(() => slot.classList.remove('spinning'), 50);
                        }
                    });
                    
                    if (iterations >= maxIterations) {
                        clearInterval(this.shuffleInterval);
                        this.shuffleInterval = null;
                        this.isShuffling = false;
                        onComplete();
                    }
                }, 100);
            }

            getPositionLabel(index) {
                if (index === 0) return 'Dealer';
                if (index === 1) return 'SB';
                if (index === 2) return 'BB';
                return null;
            }

            startTournament() {
                this.playersRemaining = this.setupData.totalPlayers;
                this.totalTime = this.setupData.levelDuration * 60;
                this.timeLeft = this.setupData.levelDuration * 60;
                this.currentLevel = 0;
                this.rebuys = 0;
                this.isRunning = false;
                this.isExtended = false;
                this.showSetup = false;
                this.showPayouts = false;
                this.showSeating = false;
                this.showRedraw = false;
                this.redrawResult = null;
                
                if (this.tableAssignments) {
                    if (this.tableAssignments.kitchenTable) {
                        this.originalPlayerNames = [...this.tableAssignments.pokerTable, ...this.tableAssignments.kitchenTable];
                    } else {
                        this.originalPlayerNames = [...this.tableAssignments.pokerTable];
                    }
                }
                this.userIsScrolling = false; // Allow auto-scroll when tournament starts
                this.render();
                this.scrollToCurrentLevel();
            }

            showRedrawSeating() {
                if (this.originalPlayerNames.length === 0) {
                    alert('No player names available. Please set up seating first.');
                    return;
                }
                this.showRedraw = true;
                this.redrawResult = null;
                this.redrawSelections = this.originalPlayerNames.map(() => false);
                this.render();
            }

            togglePlayerForRedraw(index) {
                this.redrawSelections[index] = !this.redrawSelections[index];
                this.render();
            }

            performRedraw() {
                const selectedPlayers = this.originalPlayerNames.filter((_, index) => this.redrawSelections[index]);
                
                if (selectedPlayers.length < 2) {
                    alert('Please select at least 2 players for redraw.');
                    return;
                }
                
                this.shuffleNames = selectedPlayers;
                this.startShuffleAnimation(() => {
                    const shuffled = this.shuffleArray(selectedPlayers);
                    this.redrawResult = shuffled;
                    this.render();
                });
            }

            cancelRedraw() {
                this.showRedraw = false;
                this.redrawResult = null;
                this.userIsScrolling = false; // Allow auto-scroll when closing redraw
                this.render();
                this.scrollToCurrentLevel();
            }

            closeRedrawResult() {
                this.showRedraw = false;
                this.redrawResult = null;
                this.userIsScrolling = false; // Allow auto-scroll when closing redraw
                this.render();
                this.scrollToCurrentLevel();
            }

            showSettingsMenu() {
                if (this.isGameInProgress()) {
                    this.showWarning = true;
                } else {
                    this.isRunning = false;
                    this.showSetup = true;
                }
                this.render();
            }

            confirmShowSetup() {
                this.isRunning = false;
                this.showWarning = false;
                this.showSetup = true;
                this.render();
            }

            cancelShowSetup() {
                this.showWarning = false;
                this.userIsScrolling = false; // Allow auto-scroll when closing warning
                this.render();
                this.scrollToCurrentLevel();
            }

            eliminatePlayer() {
                if (this.playersRemaining > 1) {
                    this.playersRemaining--;
                    if (this.playersRemaining === 1) {
                        this.createConfetti();
                    }
                    this.render();
                }
            }

            addPlayer() {
                if (this.playersRemaining < this.setupData.totalPlayers) {
                    this.playersRemaining++;
                    this.render();
                }
            }

            toggleTimer() {
                this.initAudioContext();
                this.isRunning = !this.isRunning;
                this.render();
            }

            addTwoMinutes() {
                this.timeLeft += 120;
                this.render();
            }

            nextLevel() {
                if (this.currentLevel < this.blindLevels.length - 1) {
                    this.currentLevel++;
                    this.timeLeft = this.totalTime;
                    this.isExtended = false;
                    this.userIsScrolling = false; // Allow auto-scroll on explicit level change
                    this.render();
                    this.scrollToCurrentLevel();
                }
            }

            prevLevel() {
                if (this.currentLevel > 0) {
                    this.currentLevel--;
                    this.timeLeft = this.totalTime;
                    this.isExtended = false;
                    this.userIsScrolling = false; // Allow auto-scroll on explicit level change
                    this.render();
                    this.scrollToCurrentLevel();
                }
            }

            toggleExtend() {
                this.isExtended = !this.isExtended;
                this.render();
            }

            toggleSound() {
                this.soundEnabled = !this.soundEnabled;
                this.render();
            }

            testSound() {
                this.playWarningSound();
            }

            addRebuy() {
                if (this.areRebuysOpen()) {
                    this.rebuys++;
                    this.render();
                }
            }

            undoRebuy() {
                if (this.rebuys > 0) {
                    this.rebuys--;
                    this.render();
                }
            }

            toggleControlPanel() {
                this.controlPanelOpen = !this.controlPanelOpen;
                this.render();
            }
        }

        const app = new PokerTimer();
        window.app = app;
    </script>
</body>
</html>
